---
title: "Immuno_analysis"
author: "Annabel Critchlow"
date: "2025-02-11"
output: html_document
---


```{r}
setwd("C:/Users/annab/OneDrive - Deakin University/PhD/Studies/FAMe Study/FAMe Data Analysis/R analysis/Immuno analysis")

library(tidyverse)
library(dplyr)
library(readxl)
library(gtsummary)
library(cardx)
library(gt)
library(ggplot2)
library(gridExtra)
library(mgcv)
library(dplyr)
library(knitr)
library(kableExtra)
library(broom)
library(ggbreak)
library(patchwork)
library(sandwich)
library(lmtest)
library(car)

data <- read_excel("C:/Users/annab/OneDrive - Deakin University/PhD/Studies/FAMe Study/FAMe Data Analysis/R analysis/FAMe_Imputed_Data.xlsx",
                   na = c("","NA", "?", "#VALUE!"),
                 trim_ws = TRUE)



```


# Define list of variables

```{r}
immunovar <-c("Ipernumber",  "IIApernumber", "Hybridpernumber", "Iperarea", "IIAperarea", "Hybridperarea", "Imeanarea", "IIAmeanarea", "Hybridmeanarea", "Tmeanarea")

postervar <-c("Ipernumber",  "IIApernumber", "Hybridpernumber", "Imeanarea", "IIAmeanarea", "Hybridmeanarea")

var_labels <-c(
  Ipernumber = "Type I fibre proportion by number (%)",
  IIApernumber = "Type IIa fibre proportion by number (%)",
  Hybridpernumber = "Type I/IIa fibre proportion by number (%)",
  Iperarea = "Type I fibre proportion by area (%)",
  IIAperarea = "Type IIa fibre proportion by area (%)",
  Hybridperarea = "Type I/IIa fibre proportion by area (%)",
  Imeanarea = expression(bold("Type I fibre CSA (µm"^2*")")), 
  IIAmeanarea = expression(bold("Type IIa fibre CSA (µm"^2*")")),
  Hybridmeanarea = expression(bold("Type I/IIa fibre CSA (µm"^2*")")),
  Tmeanarea = expression(bold("Fibre CSA of all types (µm"^2*")"))
)

poster_var_labels <-c(
  Ipernumber = "Type I fibre proportion (%)",
  IIApernumber = "Type IIa fibre proportion (%)",
  Hybridpernumber = "Type I/IIa fibre proportion (%)",
  Imeanarea = expression(bold("Type I fibre CSA (µm"^2*")")), 
  IIAmeanarea = expression(bold("Type IIa fibre CSA (µm"^2*")")),
  Hybridmeanarea = expression(bold("Type I/IIa fibre CSA (µm"^2*")"))
)

hormones <-c(hormonevariables <- c("E2", "FEI", "TT", "FAI", "prog", "TEratio"))

plot_hormone_var_labels <- c(
  E2 = "log10(Oestradiol)",
  FEI = "log10(Free oestradiol index)",
  TT = "log10(Total testosterone)",
  FAI = "log10(Free androgen index)",
  prog = "log10(Progesterone)",
  TEratio = "log10(Total testosterone/oestradiol ratio)"
)

```

# Age analysis
  
## Investigative analysis

1. Look at plots to see general trend in data across age
2. Compare spread of residuals in linear vs. polynomial models
3. Use GAM model edf value
4. Use AIC test to compare score between linear and polynomial (lower score = better)

All variables seem to fit a linear model well. 

### Visual plots

```{r}
# No model

smooth_plot_list <- list()

for (outcome in immunovar) {
  
  p <- ggplot(data, aes_string(x = "age", y = outcome)) +
    geom_point(color = "blue") +
    geom_smooth () +
    ggtitle(paste(outcome, "vs Age")) +
    theme_minimal()
  
  # Add the plot to the list
  smooth_plot_list[[outcome]] <- p
}

# Combine all plots into one page using wrap_plots
combined_plot <- wrap_plots(smooth_plot_list, ncol = 3)

pdf_filename <- paste0("Imputed_Models/Immuno_age_analysis/Investigative_plots/Smooth_Plots.pdf")
ggsave(pdf_filename, combined_plot, width = 15, height = 18)

# Linear plots

linear_plot_list <- list()

for (outcome in immunovar) {
  
  p <- ggplot(data, aes_string(x = "age", y = outcome)) +
    geom_point(color = "blue") +
    geom_smooth(method = "lm") +  # Single smooth line over all data
    ggtitle(paste(outcome, "vs Age")) +
    theme_minimal()
  
  # Add the plot to the list
  linear_plot_list[[outcome]] <- p
}

# Combine all plots into one page using wrap_plots
combined_plot <- wrap_plots(linear_plot_list, ncol = 3)

pdf_filename <- paste0("Imputed_Models/Immuno_age_analysis/Investigative_plots/Linear_Plots.pdf")
ggsave(pdf_filename, combined_plot, width = 15, height = 18)

# Polynomial plots

polynomial_plot_list <- list()

for (outcome in immunovar) {
  
  p <- ggplot(data, aes_string(x = "age", y = outcome)) +
    geom_point(color = "blue") +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
    ggtitle(paste(outcome, "vs Age")) +
    theme_minimal()
  
  # Add the plot to the list
  polynomial_plot_list[[outcome]] <- p
}

# Combine all plots into one page using wrap_plots
combined_plot <- wrap_plots(polynomial_plot_list, ncol = 3)

pdf_filename <- paste0("Imputed_Models/Immuno_age_analysis/Investigative_plots/Polynomial_Plots.pdf")
ggsave(pdf_filename, combined_plot, width = 15, height = 18)

# GAM plots

nonlinear_plot_list <- list()

for (outcome in immunovar) {
  
  p <- ggplot(data, aes_string(x = "age", y = outcome)) +
    geom_point(color = "blue") +
    geom_smooth(method = "gam") +
    ggtitle(paste(outcome, "vs Age")) +
    theme_minimal()
  
  # Add the plot to the list
  nonlinear_plot_list[[outcome]] <- p
}

# Combine all plots into one page using wrap_plots
combined_plot <- wrap_plots(nonlinear_plot_list, ncol = 3)

pdf_filename <- paste0("Imputed_Models/Immuno_age_analysis/Investigative_plots/GAM_Plots.pdf")
ggsave(pdf_filename, combined_plot, width = 15, height = 18)
```

### Investigative residual plots


```{r}
# Linear Residual plots

# Initialize a list to store the combined plots for each variable
linear_residual_plots <- list()

# Loop over each outcome variable
for (outcome in immunovar) {
  
  # Fit a linear model
  lm_model <- lm(as.formula(paste(outcome, "~ age")), data = data)
  
  # Extract residuals and fitted values
  residuals <- resid(lm_model)
  fitted <- fitted(lm_model)
  
  # Create a data frame for plotting
  plot_data <- data.frame(fitted = fitted, residuals = residuals)
  
  # Residuals vs Fitted plot
  p1 <- ggplot(plot_data, aes(x = fitted, y = residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    ggtitle(paste("Residuals vs Fitted for", outcome)) +
    theme_minimal()
  
  # Q-Q Plot of residuals
  p2 <- ggplot(plot_data, aes(sample = residuals)) +
    stat_qq(alpha = 0.6) +
    stat_qq_line() +
    ggtitle(paste("Q-Q Plot of Residuals for", outcome)) +
    theme_minimal()
  
  # Histogram of residuals
  p3 <- ggplot(plot_data, aes(x = residuals)) +
    geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
    ggtitle(paste("Histogram of Residuals for", outcome)) +
    theme_minimal()
  
  # Combine the three plots vertically
  combined_plot <- p1 / p2 / p3
  
  # Add the combined plot to the list
  linear_residual_plots[[outcome]] <- combined_plot
}

# Save all combined plots to a PDF, one page per variable
pdf("Imputed_Models/Immuno_age_analysis/Investigative_plots/Linear_Model_Residual_Plots.pdf", width = 8, height = 11)

for (plot in linear_residual_plots) {
  print(plot)
}

dev.off()

# Polynomial residual plots

# Initialize a list to store the combined plots for each variable
polynomial_residual_plots <- list()

# Loop over each outcome variable
for (outcome in immunovar) {
  
  # Fit a linear model
  lm_model <- lm(as.formula(paste(outcome, "~ poly(age, 2)")), data = data)
  
  # Extract residuals and fitted values
  residuals <- resid(lm_model)
  fitted <- fitted(lm_model)
  
  # Create a data frame for plotting
  plot_data <- data.frame(fitted = fitted, residuals = residuals)
  
  # Residuals vs Fitted plot
  p1 <- ggplot(plot_data, aes(x = fitted, y = residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    ggtitle(paste("Residuals vs Fitted for", outcome)) +
    theme_minimal()
  
  # Q-Q Plot of residuals
  p2 <- ggplot(plot_data, aes(sample = residuals)) +
    stat_qq(alpha = 0.6) +
    stat_qq_line() +
    ggtitle(paste("Q-Q Plot of Residuals for", outcome)) +
    theme_minimal()
  
  # Histogram of residuals
  p3 <- ggplot(plot_data, aes(x = residuals)) +
    geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
    ggtitle(paste("Histogram of Residuals for", outcome)) +
    theme_minimal()
  
  # Combine the three plots vertically
  combined_plot <- p1 / p2 / p3
  
  # Add the combined plot to the list
  polynomial_residual_plots[[outcome]] <- combined_plot
}

# Save all combined plots to a PDF, one page per variable
pdf("Imputed_Models/Immuno_age_analysis/Investigative_plots/Polynomial_Model_Residual_Plots.pdf", width = 8, height = 11)

for (plot in polynomial_residual_plots) {
  print(plot)
}

dev.off()

# GAM residual plots

# Initialize a list to store the combined plots for each variable
gam_residual_plots <- list()

# Loop over each outcome variable
for (outcome in immunovar) {
  
  # Fit a GAM model
  gam_model <- gam(as.formula(paste(outcome, "~ s(age)")), data = data)
  
  # Extract residuals and fitted values
  residuals <- resid(gam_model)
  fitted <- fitted(gam_model)
  
  # Create a data frame for plotting
  plot_data <- data.frame(fitted = fitted, residuals = residuals)
  
  # Residuals vs Fitted plot
  p1 <- ggplot(plot_data, aes(x = fitted, y = residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    ggtitle(paste("Residuals vs Fitted for", outcome)) +
    theme_minimal()
  
  # Q-Q Plot of residuals
  p2 <- ggplot(plot_data, aes(sample = residuals)) +
    stat_qq(alpha = 0.6) +
    stat_qq_line() +
    ggtitle(paste("Q-Q Plot of Residuals for", outcome)) +
    theme_minimal()
  
  # Histogram of residuals
  p3 <- ggplot(plot_data, aes(x = residuals)) +
    geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
    ggtitle(paste("Histogram of Residuals for", outcome)) +
    theme_minimal()
  
  # Combine the three plots vertically
  combined_plot <- p1 / p2 / p3
  
  # Add the combined plot to the list
  gam_residual_plots[[outcome]] <- combined_plot
}

# Save all combined plots to a PDF, one page per variable
pdf("Imputed_Models/Immuno_age_analysis/Investigative_plots/GAM_Model_Residual_Plots.pdf", width = 8, height = 11)

for (plot in gam_residual_plots) {
  print(plot)
}

dev.off()
```

### AIC

```{r}
# Testing the fit of models with AIC

aic_results <- data.frame(
  Variable = character(),
  Linear_AIC = numeric(),
  Polynomial_AIC = numeric(),
  stringsAsFactors = FALSE
)

# Loop over each variable
for (outcome in immunovar) {
  # Construct formulas
  linear_formula <- as.formula(paste(outcome, "~ age"))
  polynomial_formula <- as.formula(paste(outcome, "~ poly(age, 2)"))
  
  # Fit linear model
  lm_linear <- lm(linear_formula, data = data)
  
  # Fit polynomial (quadratic) model
  lm_poly <- lm(polynomial_formula, data = data)
  
  # Extract AICs
  aic_linear <- AIC(lm_linear)
  aic_poly <- AIC(lm_poly)
  
  # Append results to the data frame
  aic_results <- rbind(
    aic_results,
    data.frame(Variable = outcome, Linear_AIC = aic_linear, Polynomial_AIC = aic_poly)
  )
}

# Write the results to an Excel file
write.csv(aic_results, "Imputed_Models/Immuno_age_analysis/Investigative_plots/Linear_Poly_Model_fit.csv")

```

## Covariate testing

Adding mvpa and protein as a covariates improves fit of all models. 

```{r}
# Initialize a list to store the combined plots for each variable
linear_residual_plots <- list()

# Loop over each outcome variable
for (outcome in immunovar) {
  
  # Fit a linear model
  lm_model <- lm(as.formula(paste(outcome, "~ age + mvpa + protein")), data = data)
  
  # Extract residuals and fitted values
  residuals <- resid(lm_model)
  fitted <- fitted(lm_model)
  
  # Create a data frame for plotting
  plot_data <- data.frame(fitted = fitted, residuals = residuals)
  
  # Residuals vs Fitted plot
  p1 <- ggplot(plot_data, aes(x = fitted, y = residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    ggtitle(paste("Residuals vs Fitted for", outcome)) +
    theme_minimal()
  
  # Q-Q Plot of residuals
  p2 <- ggplot(plot_data, aes(sample = residuals)) +
    stat_qq(alpha = 0.6) +
    stat_qq_line() +
    ggtitle(paste("Q-Q Plot of Residuals for", outcome)) +
    theme_minimal()
  
  # Histogram of residuals
  p3 <- ggplot(plot_data, aes(x = residuals)) +
    geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
    ggtitle(paste("Histogram of Residuals for", outcome)) +
    theme_minimal()
  
  # Combine the three plots vertically
  combined_plot <- p1 / p2 / p3
  
  # Add the combined plot to the list
  linear_residual_plots[[outcome]] <- combined_plot
}

# Save all combined plots to a PDF, one page per variable
pdf("Imputed_Models/Immuno_age_analysis/Investigative_plots/Linear_Model_Residual_Plots_MVPA_protein.pdf", width = 8, height = 11)

for (plot in linear_residual_plots) {
  print(plot)
}

dev.off()

#AIC test comparing unadjusted and adjusted

# Testing the fit of models with AIC

aic_results <- data.frame(
  Variable = character(),
  Linear_AIC = numeric(),
  Adjusted_AIC = numeric(),
  stringsAsFactors = FALSE
)

# Loop over each variable
for (outcome in immunovar) {
  # Construct formulas
  linear_formula <- as.formula(paste(outcome, "~ age"))
  adjusted_linear_formula <- as.formula(paste(outcome, "~ age + mvpa + protein"))
  
  # Fit linear model
  lm_linear <- lm(linear_formula, data = data)
  
  # Fit polynomial (quadratic) model
  lm_adj <- lm(adjusted_linear_formula, data = data)
  
  # Extract AICs
  aic_linear <- AIC(lm_linear)
  aic_adj <- AIC(lm_adj)
  
  # Append results to the data frame
  aic_results <- rbind(
    aic_results,
    data.frame(Variable = outcome, Linear_AIC = aic_linear, Adjusted_AIC = aic_adj)
  )
}

# Write the results to an Excel file
write.csv(aic_results, "Imputed_Models/Immuno_age_analysis/Investigative_plots/Model_fit_MVPA_protein.csv")
```

#Results with plots

The models have been adjusted for mvpa and protein and the line reflects the coefficient of the adjusted model. 

```{r}

# Initialize a list to store plots
plot_list <- list()

# Create a data frame to collect all model results
all_model_results <- data.frame()

# Define the list of "nice" intervals
nice_intervals <- c(0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100, 200, 500, 1000)

for (outcome in immunovar) {
  
  # Create the formula for the linear model (outcome vs. age + mvpa)
  formula_model <- as.formula(paste(outcome, "~ age + mvpa + protein"))
  
  # Fit the linear model using your data
  model <- lm(formula_model, data = data)
  
  # Get the summary of the model
  model_summary <- summary(model)
  
  # Extract the coefficient and p-value for 'age'
  age_coef <- coef(model)["age"]
  age_p_value <- coef(summary(model))["age", "Pr(>|t|)"]
  
  # Format the labels for display
  beta_formatted <- sprintf("%.2f", age_coef)
  p_value_formatted <- sprintf("%.3f", age_p_value)
  if (p_value_formatted == "0.000") {
    p_value_formatted <- "<0.001"
  }
  
  # Define x and y variables
  x_var <- data[["age"]]
  y_var <- data[[outcome]]
  
  # Get the outcome variable label (replace with actual labels if available)
  y_label <- var_labels[[outcome]]  # or simply outcome if no label mapping
  x_label <- "Age"
  
  # Prepare the data for plotting (points)
  plot_data <- data.frame(
    x_var           = x_var,
    y_var           = y_var
  )
  
  y_min <- 0
  y_max <- max(y_var, na.rm = TRUE)
  
  raw_interval <- y_max / 8
  interval     <- nice_intervals[which(nice_intervals >= raw_interval)[1]]
  
  y_max_extended <- ceiling(y_max / interval) * interval
  
  y_breaks <- seq(y_min, y_max_extended, by = interval)
  y_limits <- c(y_min, y_max_extended)
  
  # Generate a sequence of age values across its observed range
  age_seq <- seq(
    from = min(x_var, na.rm = TRUE),
    to   = max(x_var, na.rm = TRUE),
    length.out = 100
  )
  
  # Hold mvpa at its mean (or median/other typical value)
  mean_mvpa <- mean(data$mvpa, na.rm = TRUE)
  mean_protein <- mean(data$protein, na.rm = TRUE)
  
  
  pred_data <- expand.grid(
    age            = age_seq,
    mvpa           = mean_mvpa,
    protein        = mean_protein
  )
  
  preds <- predict(model, newdata = pred_data, se.fit = TRUE)
  
  # Add fit + 95% CI to pred_data
  pred_data$fit <- preds$fit
  pred_data$se  <- preds$se.fit
  pred_data$upr <- pred_data$fit + 1.96 * pred_data$se
  pred_data$lwr <- pred_data$fit - 1.96 * pred_data$se
  
  p <- ggplot(plot_data, aes(x = x_var, y = y_var)) +
    # Raw points
    geom_point(aes(), color = "darkblue", size = 1) +
    
    # The adjusted model line in RED (holding mvpa at mean)
    geom_line(
      data = pred_data,
      aes(x = age, y = fit),
      color = "red",         # fixed red line
      size = 1.2,
      inherit.aes = FALSE
    ) +
    
    # Confidence ribbon in RED, partially transparent
    geom_ribbon(
      data = pred_data,
      aes(x = age, ymin = lwr, ymax = upr),
      alpha = 0.2,
      inherit.aes = FALSE
    ) +
    
    # Annotation for Beta and p-value
    annotate(
      "text",
      x = Inf,
      y = Inf,
      label = bquote("B" == .(beta_formatted) ~ "," ~ italic(p) == .(p_value_formatted)),
      hjust = 1.05,
      vjust = 1,
      size = 3,
      color = "black",
      fontface = "bold"
    ) +
    
    # Labels and scales
    labs(x = x_label, y = y_label, color = NULL) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 5), expand = c(0, 0.5)) +
    scale_y_continuous(breaks = y_breaks, limits = y_limits, expand = c(0, 0)) +
    
    # Theme
    theme_minimal(base_size = 16) +
    theme(
      text              = element_text(face = "bold", family = "sans"),
      axis.title        = element_text(size = 8, color = "black"),
      axis.title.y = element_text(margin = margin(r = 0)),
      axis.line         = element_line(color = "black"),
      axis.text         = element_text(size = 8, color = "black"),
      axis.ticks        = element_line(color = "black", size = 0.8),
      axis.ticks.length = unit(0.2, "cm"),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank(),
      panel.background  = element_rect(fill = "white", color = "white")
    )
  
  # Save this plot in the list
  plot_list[[length(plot_list) + 1]] <- p
  
  model_coefficients <- data.frame(
    Term        = rownames(coef(summary(model))),
    Coefficient = coef(model),
    Std_Error   = coef(summary(model))[ , "Std. Error"],
    t_value     = coef(summary(model))[ , "t value"],
    p_value     = coef(summary(model))[ , "Pr(>|t|)"]
  )
  
  # Confidence intervals
  conf_intervals <- confint(model)
  model_coefficients$CI_Lower <- conf_intervals[ , 1]
  model_coefficients$CI_Upper <- conf_intervals[ , 2]
  
  # R-squared
  R_squared <- model_summary$r.squared
  
  # Label columns
  model_coefficients$Model   = "Adjusted"
  model_coefficients$Outcome = outcome
  model_coefficients$R_squared = R_squared
  
  # Reorder columns
  model_coefficients <- model_coefficients[ , c("Model", "Outcome", "Term", "Coefficient",
                                                "Std_Error", "CI_Lower", "CI_Upper",
                                                "p_value", "R_squared")]
  # Append to the results data frame
  all_model_results <- rbind(all_model_results, model_coefficients)
  
}  # End outcome loop

combined_plot <- wrap_plots(plot_list, ncol = 4) + 
  plot_annotation(tag_levels = 'A') & 
  theme(
    plot.tag = element_text(size = 12),
    plot.tag.position = c(-0.02, 1.04)  # Move tags up
  )

tiff_filename <- "Imputed_Models/Immuno_age_analysis/Linear_models/Linear_Plots.tiff"
ggsave(tiff_filename, combined_plot, width = 12, height = 8, dpi = 600, device = "tiff")

write.csv(all_model_results,
          file = "Imputed_Models/Immuno_age_analysis/Linear_models/Linear_results.csv",
         row.names = FALSE)

```

# Hormone analysis

## Unadjusted models

```{r}

# Initialize empty data frames to store combined results
all_unadjusted_results <- data.frame()

for (hormone in hormones) {

# Initialize empty data frames to store results
unadjusted_results <- data.frame()

 # Create a PDF file to save the unadjusted model plots
  pdf(file = paste0("Imputed_models/Immuno_hormone_analysis/Unadjusted_models/Residual_Plots_", hormone, ".pdf"))
  
  # Loop over each outcome variable for unadjusted models
  for (outcome in immunovar) {
    # Create the formula for the linear model
    formula_unadjusted <- as.formula(paste(outcome, "~", hormone))
    
    # Fit the linear model
    model_unadjusted <- lm(formula_unadjusted, data = data)
    
    # Extract residuals and fitted values
    residuals <- resid(model_unadjusted)
    fitted_values <- fitted(model_unadjusted)
    
    # Set up the plotting area to have three plots per page
    par(mfrow = c(3, 1))
    
    # 1. Residuals vs Fitted Plot
    plot(fitted_values, residuals,
         main = paste("Unadjusted Model Residuals vs Fitted for", outcome, "and", hormone),
         xlab = "Fitted Values",
         ylab = "Residuals")
    abline(h = 0, col = "red")
    
    # 2. Q-Q Plot of Residuals
    qqnorm(residuals,
           main = paste("Unadjusted Model Normal Q-Q Plot for", outcome, "and", hormone),
           ylab = "Quantiles of Residuals")
    qqline(residuals, col = "red")
    
    # 3. Histogram of Residuals
    hist(residuals,
         main = paste("Unadjusted Model Histogram of Residuals for", outcome, "and", hormone),
         xlab = "Residuals",
         breaks = 20)
    
    # Extract model summary statistics using broom
    tidy_unadjusted <- tidy(model_unadjusted, conf.int = TRUE)
    glance_unadjusted <- glance(model_unadjusted)
    
    # Add model and outcome information
    tidy_unadjusted$Model <- "Unadjusted"
    tidy_unadjusted$Outcome <- outcome
    tidy_unadjusted$Hormone <- hormone
    tidy_unadjusted$R_squared <- glance_unadjusted$r.squared
    
    # Reorder columns
    tidy_unadjusted <- tidy_unadjusted[, c("Model", "Outcome", "Hormone", "term", "estimate", "std.error", "conf.low", "conf.high", "p.value", "R_squared")]
    colnames(tidy_unadjusted) <- c("Model", "Outcome", "Hormone", "Term", "Coefficient", "Std_Error", "CI_Lower", "CI_Upper", "p_value", "R_squared")
    
    # Append to the unadjusted results data frame
    unadjusted_results <- rbind(unadjusted_results, tidy_unadjusted)
  }
  
  # Close the PDF device for unadjusted models
  dev.off()
  
  # Append to the combined unadjusted results data frame
  all_unadjusted_results <- rbind(all_unadjusted_results, unadjusted_results)

  }

# Save the combined unadjusted results to a CSV file
write.csv(all_unadjusted_results, file = "Imputed_models/Immuno_hormone_analysis/Unadjusted_models/All_Unadjusted_results.csv", row.names = FALSE)

```

## Adjusted models

Covariates to include: age, protein, and mvpa

```{r}
# Define covariates
covariates <- c("age", "mvpa", "protein")

# Initialize empty data frames to store combined results
all_adjusted_results <- data.frame()
all_vif_results <- data.frame()

for (hormone in hormones) {

  # Initialize empty data frames to store results
  adjusted_results <- data.frame()
  vif_results <- data.frame()
  
  # Loop over each outcome variable for adjusted models
  for (outcome in immunovar) {
    # Create the formula for the adjusted linear model
    formula_adjusted <- as.formula(
      paste(outcome, "~", paste(c(hormone, covariates), collapse = " + "))
    )
    
    # Fit the linear model
    model_adjusted <- lm(formula_adjusted, data = data)
    
    # Extract model summary statistics using broom
    tidy_adjusted <- tidy(model_adjusted, conf.int = TRUE)
    glance_adjusted <- glance(model_adjusted)
    
    # Add model and outcome information
    tidy_adjusted$Model <- "Adjusted"
    tidy_adjusted$Outcome <- outcome
    tidy_adjusted$Hormone <- hormone
    
    # Get R-squared from glance
    tidy_adjusted$R_squared <- glance_adjusted$r.squared
    
    # Get AIC from glance
    tidy_adjusted$AIC <- glance_adjusted$AIC
    
    # Reorder columns (now including AIC)
    tidy_adjusted <- tidy_adjusted[, c(
      "Model", "Outcome", "Hormone", 
      "term", "estimate", "std.error", 
      "conf.low", "conf.high", 
      "p.value", "R_squared", 
      "AIC"
    )]
    
    colnames(tidy_adjusted) <- c(
      "Model", "Outcome", "Hormone", 
      "Term", "Coefficient", "Std_Error", 
      "CI_Lower", "CI_Upper", 
      "p_value", "R_squared", 
      "AIC"
    )
    
    # Append to the adjusted results data frame
    adjusted_results <- rbind(adjusted_results, tidy_adjusted)
    
    # Calculate VIFs for the adjusted model
    vif_values <- vif(model_adjusted)
    vif_df <- data.frame(
      Model = "Adjusted",
      Outcome = outcome,
      Hormone = hormone,
      Term = names(vif_values),
      VIF = vif_values
    )
    # Append to the VIF results data frame
    vif_results <- rbind(vif_results, vif_df)
  }
  
  
  # Append to the combined adjusted results data frame
  all_adjusted_results <- rbind(all_adjusted_results, adjusted_results)
  
  # Append to the combined VIF results data frame
  all_vif_results <- rbind(all_vif_results, vif_results)
  
}

# Save the combined adjusted results to a CSV file
write.csv(
  all_adjusted_results, 
  file = "Imputed_models/Immuno_hormone_analysis/Adjusted_models/Adjusted_results_age_mvpa_protein.csv", 
  row.names = FALSE
)

# Save the combined VIF results to a CSV file
write.csv(
  all_vif_results, 
  file = "Imputed_models/Immuno_hormone_analysis/Adjusted_models/VIF_results_age_mvpa_protein.csv", 
  row.names = FALSE
)


```

## Standardised, robust models

Models adjusted for age, protein, mvpa

```{r}

covariates <- c("age","mvpa", "protein")

# Standardize the specific variables
data_transformed <- data %>%
  mutate(across(all_of(hormones), ~ log10(.))) 
data_standardized <- data %>%
  mutate(across(all_of(c(immunovar, covariates, hormones)), scale))

# Initialize empty data frames to store combined results
all_robust_adjusted_results <- data.frame()

# Loop over each hormone
for (hormone in hormones) {
  
  # Initialize empty data frame to store results
  robust_adjusted_results <- data.frame()
  
  # Loop over each outcome variable for adjusted models with robust standard errors
  for (outcome in immunovar) {
    
    # Create the formula for the adjusted linear model
    formula_adjusted <- as.formula(paste(outcome, "~", paste(c(hormone, covariates), collapse = " + ")))
    
    # Fit the linear model using standardized data
    model_adjusted <- lm(formula_adjusted, data = data_standardized)
    
    # Calculate robust standard errors
    robust_se <- vcovHC(model_adjusted, type = "HC1")
    robust_summary <- coeftest(model_adjusted, vcov = robust_se)
    
    # Extract coefficients and p-values from robust summary
    robust_coefficients <- data.frame(
      Term = rownames(robust_summary),
      Coefficient = robust_summary[, "Estimate"],
      Std_Error = robust_summary[, "Std. Error"],
      t_value = robust_summary[, "t value"],
      p_value = robust_summary[, "Pr(>|t|)"]
    )
    
    # Calculate confidence intervals manually
    alpha <- 0.05  # 95% confidence interval
    critical_value <- qt(1 - alpha/2, df = model_adjusted$df.residual)
    robust_coefficients$CI_Lower <- robust_coefficients$Coefficient - critical_value * robust_coefficients$Std_Error
    robust_coefficients$CI_Upper <- robust_coefficients$Coefficient + critical_value * robust_coefficients$Std_Error
    
    # Get R-squared from the original model
    glance_adjusted <- glance(model_adjusted)
    
    # Add model, outcome, and hormone information
    robust_coefficients$Model <- "Robust Adjusted"
    robust_coefficients$Outcome <- outcome
    robust_coefficients$Hormone <- hormone
    robust_coefficients$R_squared <- glance_adjusted$r.squared
    
    # Reorder columns
    robust_coefficients <- robust_coefficients[, c("Model", "Outcome", "Hormone", "Term", "Coefficient", "Std_Error",
                                                   "CI_Lower", "CI_Upper", "p_value", "R_squared")]
    
    # Append to the robust adjusted results data frame
    robust_adjusted_results <- rbind(robust_adjusted_results, robust_coefficients)
    
  }  # End of outcome loop
  
  # Append to the combined robust adjusted results data frame
  all_robust_adjusted_results <- rbind(all_robust_adjusted_results, robust_adjusted_results)
  
}  # End of hormone loop

# Save the combined robust adjusted results to a CSV file
write.csv(all_robust_adjusted_results, file = "Imputed_models/Immuno_hormone_analysis/Robust_standardised_adjusted_models/Robust_Adjusted_results.csv", row.names = FALSE)
```

## Plots

These plots have been adjusted for the covariates:age, protein, mvpa

```{r}

covariates <- c("age","mvpa", "protein") 

# Standardize all variables including covariates and convert to numeric
data_standardized <- data %>%
  mutate(across(all_of(c(immunovar, covariates, hormones)), ~ as.numeric(scale(.))))

# Calculate means and SDs for back-transformation
means_sds <- data.frame(
  Variable = c(immunovar, hormones),
  Mean = sapply(data[c(immunovar, hormones)], mean, na.rm = TRUE),
  SD = sapply(data[c(immunovar, hormones)], sd, na.rm = TRUE)
)

# Initialize empty data frames to store combined results
all_robust_adjusted_results <- data.frame()

# Loop over each hormone
for (hormone in hormones) {
  
  # Initialize a list to store plots for each hormone
  hormone_plot_list <- list()
  
  # Loop over each outcome variable
  for (outcome in immunovar) {
    
    # Create the formula for the adjusted linear model
    formula_adjusted <- as.formula(paste(outcome, "~", paste(c(hormone, covariates), collapse = " + ")))
    
    # Fit the linear model using standardized data
    model_adjusted <- lm(formula_adjusted, data = data_standardized)
    
    # Calculate robust standard errors
    robust_se <- vcovHC(model_adjusted, type = "HC1")
    robust_summary <- coeftest(model_adjusted, vcov = robust_se)
    
    # Extract the coefficient and p-value for the hormone
    hormone_coef <- robust_summary[rownames(robust_summary) == hormone, "Estimate"]
    hormone_p_value <- robust_summary[rownames(robust_summary) == hormone, "Pr(>|t|)"]
    
    # Format the labels for display
    beta_formatted <- sprintf("%.2f", hormone_coef)
    p_value_formatted <- sprintf("%.3f", hormone_p_value)
    if (p_value_formatted == "0.000") {
    p_value_formatted <- "<0.001"
  }
    
    # Define x_var (hormone variable on transformed scale)
    x_var <- data_transformed[[hormone]]
    y_var <- data[[outcome]]  # Original outcome variable
    
    # Get the outcome variable label
    y_label <- var_labels[[outcome]]        # Replace with your variable labels
    x_label <- plot_hormone_var_labels[[hormone]] # Replace with your hormone labels
    
    # Prepare the data for plotting
    plot_data <- data.frame(
      x_var = x_var,
      y_var = y_var,
      age = data[["age"]]
    )
    
  y_min <- 0
y_max <- max(y_var, na.rm = TRUE)

if (is.finite(y_max) && y_max > 0) {
  raw_interval <- y_max / 5
  nice_intervals <- c(0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100, 1000)
  
  # Find first nice interval >= raw_interval
  idx <- which(nice_intervals >= raw_interval)
  interval <- if (length(idx) == 0) {
    # Fallback if none is found
    max(nice_intervals)  
  } else {
    nice_intervals[idx[1]]
  }
  
  # Create the sequence
  y_breaks <- seq(y_min, ceiling(y_max / interval) * interval, by = interval)
  y_limits <- c(y_min, max(y_breaks))
} else {
  # Handle the case where y_max isn't suitable
  y_breaks <- NULL
  y_limits <- c(0, 1)  # or skip
}
    
    ### Generate Adjusted Predictions for Plotting
    
    # Create a sequence of hormone values over the observed range
    hormone_seq <- seq(min(x_var, na.rm = TRUE), max(x_var, na.rm = TRUE), length.out = 100)
    
    # Standardize the hormone sequence using original mean and SD
    hormone_mean <- mean(data_transformed[[hormone]], na.rm = TRUE)
    hormone_sd <- sd(data_transformed[[hormone]], na.rm = TRUE)
    hormone_seq_standardized <- (hormone_seq - hormone_mean) / hormone_sd
    
    # Prepare the new data for prediction
    newdata <- data.frame(
      hormone_seq_standardized
    )
    names(newdata) <- hormone  # Ensure the column name matches the model
    
    # Set covariates to their mean (zero after standardization)
    for (covariate in covariates) {
      newdata[[covariate]] <- 0  # Mean of standardized variables
    }
    
    # Ensure that variable types in newdata match those in data_standardized
    newdata <- newdata %>%
      mutate(across(everything(), as.numeric))
    
    # Predict the standardized outcome variable
    predicted_standardized <- predict(model_adjusted, newdata = newdata)
    
    # Back-transform the predicted values to the original scale
    outcome_mean <- mean(data[[outcome]], na.rm = TRUE)
    outcome_sd <- sd(data[[outcome]], na.rm = TRUE)
    predicted_outcome <- predicted_standardized * outcome_sd + outcome_mean
    
    # Create a data frame for plotting the adjusted line
    adjusted_line_data <- data.frame(
      x_var = hormone_seq,
      y_var = predicted_outcome
    )
    
    # Generate the plot
    p <- ggplot(plot_data, aes(x = x_var, y = y_var, color = age)) +
      geom_point(size = 3, alpha = 0.9) +
      scale_color_gradient(low = "lightblue", high = "darkblue", guide = guide_colorbar(ticks = FALSE)) +
      geom_line(data = adjusted_line_data, aes(x = x_var, y = y_var), color = "red", size = 1.2) +
      annotate("text", x = Inf, y = Inf, label = bquote(beta == .(beta_formatted) ~ "," ~ italic(p) == .(p_value_formatted)),
               hjust = 1.05, vjust = 1.5, size = 5, color = "black", fontface = "bold") +
      labs(x = x_label, y = y_label, color = "Age (years)") +
      scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +
      scale_y_continuous(breaks = y_breaks, limits = y_limits, expand = c(0, 0)) +
      theme_minimal(base_size = 16) +
      theme(
        text = element_text(face = "bold", family = "sans"),
        axis.title = element_text(size = 14, color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12, color = "black"),
        axis.ticks = element_line(color = "black", size = 0.8),
        axis.ticks.length = unit(0.2, "cm"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "white"),
        legend.position = "none"
      )
    
    # Collect the plot in the list for the current hormone
    hormone_plot_list[[length(hormone_plot_list) + 1]] <- p
    
  }  # End of outcome loop
  
  # Combine all plots for the current hormone into one page using wrap_plots
  combined_plot <- wrap_plots(hormone_plot_list, ncol = 3)
  
  # Save the combined plot to a PDF file
  pdf_filename <- paste0("Imputed_models/Immuno_hormone_analysis/Robust_standardised_adjusted_models/Adjusted_Plots", hormone, ".pdf")
  ggsave(pdf_filename, combined_plot, width = 20, height = 25)
  
}  # End of hormone loop


```

## Two hormone models

### AIC

```{r}
# Testing the fit of models with AIC

aic_results <- data.frame(
  Variable = character(),
  Linear_AIC = numeric(),
  Polynomial_AIC = numeric(),
  stringsAsFactors = FALSE
)

# Loop over each variable
for (outcome in immunovar) {
  # Construct formulas
  onehormone_formula <- as.formula(paste(outcome, "~ E2 + protein + mvpa"))
  twohormone_formula <- as.formula(paste(outcome, "~ E2 + prog + protein + mvpa"))
  
  # Fit linear model
  lm_onehormone <- lm(onehormone_formula, data = data)
  
  # Fit polynomial (quadratic) model
  lm_twohormone <- lm(twohormone_formula, data = data)
  
  # Extract AICs
  aic_onehormone <- AIC(lm_onehormone)
  aic_twohormone <- AIC(lm_twohormone)
  
  # Append results to the data frame
  aic_results <- rbind(
    aic_results,
    data.frame(Variable = outcome, One_AIC = aic_onehormone, Two_AIC = aic_twohormone)
  )
}

# Write the results to an Excel file
write.csv(aic_results, "Imputed_Models/Immuno_hormone_analysis/Multiple_Hormones/Two_hormone_Poly_Model_fit.csv")

```


### VIF and residuals

```{r}

# Define covariates and hormones to run through
covariates <- c("age", "prog", "mvpa", "protein")
hormones <- c("E2", "FEI")

# Initialize empty data frames to store combined results
all_adjusted_results <- data.frame()
all_vif_results <- data.frame()

for (hormone in hormones) {

  # Initialize empty data frames to store results
  adjusted_results <- data.frame()
  vif_results <- data.frame()
  
  # Loop over each outcome variable for adjusted models
  for (outcome in immunovar) {
    # Create the formula for the adjusted linear model
    formula_adjusted <- as.formula(
      paste(outcome, "~", paste(c(hormone, covariates), collapse = " + "))
    )
    
    # Fit the linear model
    model_adjusted <- lm(formula_adjusted, data = data)
    
    # Extract model summary statistics using broom
    tidy_adjusted <- tidy(model_adjusted, conf.int = TRUE)
    glance_adjusted <- glance(model_adjusted)
    
    # Add model and outcome information
    tidy_adjusted$Model <- "Adjusted"
    tidy_adjusted$Outcome <- outcome
    tidy_adjusted$Hormone <- hormone
    
    # Get R-squared from glance
    tidy_adjusted$R_squared <- glance_adjusted$r.squared
    
    # Get AIC from glance
    tidy_adjusted$AIC <- glance_adjusted$AIC
    
    # Reorder columns (now including AIC)
    tidy_adjusted <- tidy_adjusted[, c(
      "Model", "Outcome", "Hormone", 
      "term", "estimate", "std.error", 
      "conf.low", "conf.high", 
      "p.value", "R_squared", 
      "AIC"
    )]
    
    colnames(tidy_adjusted) <- c(
      "Model", "Outcome", "Hormone", 
      "Term", "Coefficient", "Std_Error", 
      "CI_Lower", "CI_Upper", 
      "p_value", "R_squared", 
      "AIC"
    )
    
    # Append to the adjusted results data frame
    adjusted_results <- rbind(adjusted_results, tidy_adjusted)
    
    # Calculate VIFs for the adjusted model
    vif_values <- vif(model_adjusted)
    vif_df <- data.frame(
      Model = "Adjusted",
      Outcome = outcome,
      Hormone = hormone,
      Term = names(vif_values),
      VIF = vif_values
    )
    # Append to the VIF results data frame
    vif_results <- rbind(vif_results, vif_df)
  }
  
  
  # Append to the combined adjusted results data frame
  all_adjusted_results <- rbind(all_adjusted_results, adjusted_results)
  
  # Append to the combined VIF results data frame
  all_vif_results <- rbind(all_vif_results, vif_results)
  
}

# Save the combined adjusted results to a CSV file
write.csv(
  all_adjusted_results, 
  file = "Imputed_models/Immuno_hormone_analysis/Multiple_Hormones/2Hormone_Adjusted_results_age_mvpa_protein.csv", 
  row.names = FALSE
)

# Save the combined VIF results to a CSV file
write.csv(
  all_vif_results, 
  file = "Imputed_models/Immuno_hormone_analysis/Multiple_Hormones/2Hormone_VIF_results_age_mvpa_protein.csv", 
  row.names = FALSE
)

```

### Standardised robust models

```{r}

# Define covariates and hormones to run through
covariates <- c("age", "prog", "mvpa", "protein")
hormones <- c("E2", "FEI")

# Standardize the specific variables
data_transformed <- data %>%
  mutate(across(all_of(hormones), ~ log10(.))) 
data_standardized <- data %>%
  mutate(across(all_of(c(immunovar, covariates, hormones)), scale))

# Initialize empty data frames to store combined results
all_robust_adjusted_results <- data.frame()

# Loop over each hormone
for (hormone in hormones) {
  
  # Initialize empty data frame to store results
  robust_adjusted_results <- data.frame()
  
  # Loop over each outcome variable for adjusted models with robust standard errors
  for (outcome in immunovar) {
    
    # Create the formula for the adjusted linear model
    formula_adjusted <- as.formula(paste(outcome, "~", paste(c(hormone, covariates), collapse = " + ")))
    
    # Fit the linear model using standardized data
    model_adjusted <- lm(formula_adjusted, data = data_standardized)
    
    # Calculate robust standard errors
    robust_se <- vcovHC(model_adjusted, type = "HC1")
    robust_summary <- coeftest(model_adjusted, vcov = robust_se)
    
    # Extract coefficients and p-values from robust summary
    robust_coefficients <- data.frame(
      Term = rownames(robust_summary),
      Coefficient = robust_summary[, "Estimate"],
      Std_Error = robust_summary[, "Std. Error"],
      t_value = robust_summary[, "t value"],
      p_value = robust_summary[, "Pr(>|t|)"]
    )
    
    # Calculate confidence intervals manually
    alpha <- 0.05  # 95% confidence interval
    critical_value <- qt(1 - alpha/2, df = model_adjusted$df.residual)
    robust_coefficients$CI_Lower <- robust_coefficients$Coefficient - critical_value * robust_coefficients$Std_Error
    robust_coefficients$CI_Upper <- robust_coefficients$Coefficient + critical_value * robust_coefficients$Std_Error
    
    # Get R-squared from the original model
    glance_adjusted <- glance(model_adjusted)
    
    # Add model, outcome, and hormone information
    robust_coefficients$Model <- "Robust Adjusted"
    robust_coefficients$Outcome <- outcome
    robust_coefficients$Hormone <- hormone
    robust_coefficients$R_squared <- glance_adjusted$r.squared
    
    # Reorder columns
    robust_coefficients <- robust_coefficients[, c("Model", "Outcome", "Hormone", "Term", "Coefficient", "Std_Error",
                                                   "CI_Lower", "CI_Upper", "p_value", "R_squared")]
    
    # Append to the robust adjusted results data frame
    robust_adjusted_results <- rbind(robust_adjusted_results, robust_coefficients)
    
  }  # End of outcome loop
  
  # Append to the combined robust adjusted results data frame
  all_robust_adjusted_results <- rbind(all_robust_adjusted_results, robust_adjusted_results)
  
}  # End of hormone loop

# Save the combined robust adjusted results to a CSV file
write.csv(all_robust_adjusted_results, file = "Imputed_models/Immuno_hormone_analysis/Multiple_Hormones/2Hormone_Robust_Adjusted_results.csv", row.names = FALSE)

```

